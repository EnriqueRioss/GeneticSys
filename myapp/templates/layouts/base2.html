{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}

<head>
    <link rel="stylesheet" href="{% static '/styles/stylesforms.css' %}">
</head>

<div class="main-content">
    <div class="form-container">

        <div class="form-container-card">
            <div class="card-header">
                <div>
                    <h1>Historia Clínica Genética</h1>
                    <p>Complete todos los campos requeridos para crear la historia clínica</p>
                </div>
                <div class="step-indicator" id="stepIndicator">Paso 1 de 7</div>
            </div>

            <!--Barra de progreso-->

            <!--DE MOMENTO ESTO QUEDARA EN STAND BY PORQUE DEBO VER COMO SE INCORPORA EN EL RESTO DE LOS FORMULARIOS-->
            <div class="seccion-progreso">
                <p class="progress-title">Progreso del formulario</p>
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
                <p class="progress-percentage">17% completado</p>
            </div>

            <div class="stepper">
                <!--Primer paso-->
                <div class="stepper-item active" data-step="1">
                    <div class="step-counter">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="step-name">
                        <p class="font-bold">Informacion General</p>
                    </div>
                </div>


                <!--Segundo paso-->
                <div class="stepper-item" data-step="2">
                    <div class="step-counter">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="step-name">
                        <p>Datos del Proposito</p>
                    </div>
                </div>

                <!--Tercer Paso-->
                <!--SOLO APARECE SI EL ES UN PROPOSITO, SON LOS DATOS DE LOS PADRES-->
                <div class="stepper-item" data-step="3">
                    <div class="step-counter">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="step-name">
                        <p>Datos del Representante</p>
                    </div>
                </div>

                <!--Cuarto paso-->
                <div class="stepper-item" data-step="4">
                    <div class="step-counter">
                        <i class="fas fa-file-medical"></i>
                    </div>
                    <div class="step-name">
                        <p>Antecedentes Personales</p>
                    </div>
                </div>

                <!--Quinto paso-->
                <div class="stepper-item" data-step="5">
                    <div class="step-counter">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="step-name">
                        <p>Datos preconcepcionales</p>
                    </div>
                </div>

                <!--Sexto paso-->
                <div class="stepper-item" data-step="6">
                    <div class="step-counter">
                        <i class="fas fa-stethoscope"></i>
                    </div>
                    <div class="step-name">
                        <p>Examen Fisico</p>
                    </div>
                </div>

                <!--Septimo paso-->
                <div class="stepper-item" data-step="7">
                    <div class="step-counter">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="step-name">
                        <p>Diagnóstico Final</p>
                    </div>
                </div>
            </div>

            <!-- COMENTO ESTOS MENSAJES SOLO POR LAS PRUEBAS QUE SE ESTAN HACIENDO, CUALQUIER COSA
             MAS ADELANTE SE DESCOMENTAN, PORQUE NO SE SI TE VAYA A OCASIONAR PROBLEMAS

            <div class="main-content-area">
                {% if messages %}
                    <div class="messages-container">
                        <ul class="messages">
                            {% for message in messages %}
                                <li{% if message.tags %} class="message-item {{ message.tags }}"{% endif %}>
                                    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
                                        <i class="fas fa-times-circle"></i> Error:
                                    {% elif message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
                                        <i class="fas fa-check-circle"></i> Éxito:
                                    {% elif message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}
                                        <i class="fas fa-exclamation-triangle"></i> Advertencia:
                                    {% elif message.level == DEFAULT_MESSAGE_LEVELS.INFO and not 'POPUP:' in message.message %}
                                        <i class="fas fa-info-circle"></i> Información:
                                    {% endif %}
                                    {% if not 'POPUP:' in message.message %}
                                        {{ message }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                -->

                <div class="content">
                    {% block form_content %}
                    {% endblock form_content %}
                </div>
            </div>
        </div>
    </div>
</div>


    
    <!-- ================================================================= -->
    <!-- === REUSABLE AJAX FORM HANDLING SCRIPT ========================== -->
    <!-- ================================================================= -->
<script>
        function setupAjaxForm(formId) {
            const form = document.getElementById(formId);
            if (!form) {
                console.error(`Form with ID "${formId}" not found.`);
                return;
            }
        
            let clickedButton = null;
        
            // 1. Captura qué botón de envío fue clickeado
            form.querySelectorAll('button[type="submit"]').forEach(button => {
                button.addEventListener('click', function() {
                    clickedButton = this;
                });
            });
        
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // Detener el envío normal
        
                const formData = new FormData(form);
        
                // 2. Añade el nombre y valor del botón clickeado al FormData
                if (clickedButton) {
                    formData.append(clickedButton.name, clickedButton.value || '');
                }
        
                // Limpiar errores previos
                form.querySelectorAll('.field-errors').forEach(el => el.innerHTML = '');
                const nonFieldErrors = form.querySelector('.non-field-errors');
                if (nonFieldErrors) nonFieldErrors.innerHTML = '';
        
        
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        // El CSRF token ya está en el FormData, no es necesario en headers
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.redirect_url) {
                        // Redirección exitosa
                        window.location.href = data.redirect_url;
                    } else {
                        // Manejar errores de validación
                        if (data.errors) {
                            // Errores globales del formulario
                            if (data.errors.__all__) {
                                data.errors.__all__.forEach(error => {
                                    if(nonFieldErrors) nonFieldErrors.innerHTML += `<span>${error}</span>`;
                                });
                            }
                            // Errores específicos de cada campo
                            for (const fieldName in data.errors) {
                                if (fieldName !== '__all__') {
                                    const errorDiv = document.getElementById(`error_id_${fieldName}`);
                                    const fieldErrorContainer = form.querySelector(`#error_id_${fieldName}`);
        
                                    if (fieldErrorContainer) {
                                        let errorHtml = '';
                                        data.errors[fieldName].forEach(error => {
                                            errorHtml += `<span>${error.message || error}</span>`;
                                        });
                                        fieldErrorContainer.innerHTML = errorHtml;
                                    }
                                }
                            }
                        } else {
                             if(nonFieldErrors) nonFieldErrors.innerHTML = '<span>Ocurrió un error inesperado.</span>';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error en la petición AJAX:', error);
                    if(nonFieldErrors) nonFieldErrors.innerHTML = '<span>Error de conexión. Intente de nuevo.</span>';
                });
        
                // Resetear el botón clickeado para el próximo envío
                clickedButton = null;
            });
        }
      

    document.addEventListener('DOMContentLoaded', function() {
        {% if messages %}
            {% for message in messages %}
                {% if 'POPUP:' in message.message %}
                    alert("{{ message.message|slice:'7:'|escapejs }}");
                {% endif %}
            {% endfor %}
        {% endif %}
    });
</script>

{% endblock %}